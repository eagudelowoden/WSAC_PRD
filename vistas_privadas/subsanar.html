<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subsanar Documentos | WSAC</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="/css/subsanar.css">
</head>
<body>

<div id="app" class="app-container">
    <div class="subsanar-card animate-in">

        <div v-if="loading" class="p-5 text-center">
            <div class="spinner-grow text-warning" role="status"></div>
            <p class="mt-3 fw-bold text-muted small">Validando acceso seguro...</p>
        </div>

        <div v-else-if="enviado" class="p-5 text-center animate-in">
            <i class="bi bi-shield-check display-3 text-success"></i>
            <h4 class="fw-bold mt-3">¡Documentación Recibida!</h4>
            <p class="text-muted small">Tus archivos se han subido con éxito.</p>
        </div>

        <div v-else-if="error" class="p-5 text-center animate-in">
            <i class="bi bi-shield-exclamation display-3 text-danger"></i>
            <h4 class="fw-bold mt-3">Acceso Denegado</h4>
            <p class="text-muted small">{{ error }}</p>
        </div>

        <div v-else>
            <header class="card-header-tech">
                <div class="security-icon-top"><i class="bi bi-shield-lock"></i></div>
                <h3>Carga de Documentos</h3>
            </header>

            <div class="card-body-modern">
                <div class="text-center mb-3">
                    <div class="connection-badge">
                        <i class="bi bi-record-fill me-2 animate-pulse"></i> CONEXIÓN SEGURA
                    </div>
                    <p class="text-muted small">Hola, <strong>{{ usuario.nombres }}</strong>. Adjunta tus soportes.</p>
                </div>

                <form @submit.prevent="procesarSubida">
                    
                    <div class="d-flex align-items-center justify-content-center mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="m" v-model="modoClasificar">
                            <label class="form-check-label small text-muted ms-2" for="m">Clasificar individualmente</label>
                        </div>
                    </div>

                    <div v-if="modoClasificar" class="mb-3 animate-in">
                        <select v-model="tipoDoc" class="form-select form-select-sm border-2">
                            <option value="" disabled>Seleccione Categoría</option>
                            <option value="cedula">Cédula de Ciudadanía</option>
                            <option value="hojaVida">Hoja de Vida</option>
                            <option value="certificados">Certificados de Estudio</option>
                        </select>
                    </div>

                    <div class="drop-zone-premium" :class="{'active': archivos.length > 0}" @click="triggerFileInput">
                        <input ref="archivoInput" type="file" class="d-none" @change="handleFileSelect" :multiple="!modoClasificar">
                        <i :class="archivos.length === 0 ? 'bi bi-cloud-arrow-up' : 'bi bi-plus-circle-dotted'" 
                           :style="{ color: '#e2712a' }" 
                           style="font-size: 2rem;"></i>
                        <p class="small fw-bold mb-0 mt-1">
                            {{ archivos.length === 0 ? 'Toca para agregar archivos' : 'Toca para agregar más...' }}
                        </p>
                    </div>

                    <div v-if="archivos.length > 0" class="file-list mt-3">
                        <div v-for="(f, index) in archivos" :key="index" class="file-item d-flex justify-content-between align-items-center">
                            <span class="text-truncate" style="max-width: 85%; font-size: 0.8rem;">
                                <i class="bi bi-file-earmark-check text-success me-1"></i> {{ f.name }}
                            </span>
                            <i class="bi bi-x-circle text-danger cursor-pointer" @click.stop="eliminarArchivo(index)"></i>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-upload-tech w-100">
                        ENVIAR {{ archivos.length > 0 ? '(' + archivos.length + ')' : '' }} ARCHIVOS
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp } = Vue;
    const URL_BASE = ''; 

    createApp({
        data() {
            return {
                token: '',
                loading: true,
                enviado: false,
                error: null,
                usuario: { nombres: '' },
                tipoDoc: '',           
                modoClasificar: false, 
                archivos: []            
            }
        },
        mounted() {
            const params = new URLSearchParams(window.location.search);
            this.token = params.get('token');
            if (!this.token) { 
                this.error = "Token de acceso no válido."; 
                this.loading = false; 
                return; 
            }
            this.validarToken();
        },
        methods: {
            triggerFileInput() { 
                this.$refs.archivoInput.click(); 
            },
            
            handleFileSelect(event) {
                const nuevos = Array.from(event.target.files);
                if (this.modoClasificar) {
                    this.archivos = nuevos;
                } else {
                    const listaTemporal = [...this.archivos, ...nuevos];
                    if (listaTemporal.length > 5) {
                        Swal.fire('Límite', 'Máximo 5 archivos.', 'warning');
                        this.archivos = listaTemporal.slice(0, 5); 
                    } else {
                        this.archivos = listaTemporal;
                    }
                }
                event.target.value = '';
            },

            eliminarArchivo(index) {
                this.archivos.splice(index, 1);
            },

            async validarToken() {
                try {
                    const res = await fetch(`${URL_BASE}/api/validar-token/${this.token}`);
                    const data = await res.json();
                    if (data.status === 'ok') { 
                        this.usuario = data.usuario; 
                        this.loading = false;
                    } else { 
                        this.error = data.message;
                        this.loading = false;
                    }
                } catch (e) { 
                    this.error = "Error de conexión."; 
                    this.loading = false;
                }
            },

            async procesarSubida() {
                if (this.archivos.length === 0) {
                    Swal.fire('Atención', 'Selecciona al menos un archivo.', 'warning');
                    return;
                }
                
                try {
                    Swal.fire({
                        title: 'Enviando...',
                        html: 'Subiendo soportes...',
                        allowOutsideClick: false,
                        didOpen: () => { Swal.showLoading() }
                    });

                    let subidos = 0;
                    for (const archivo of this.archivos) {
                        const formData = new FormData();
                        formData.append('token', this.token);
                        formData.append('tipoDocumento', this.modoClasificar ? this.tipoDoc : 'GENERAL');
                        formData.append('archivo', archivo);

                        const res = await fetch(`${URL_BASE}/api/subir-correccion`, {
                            method: 'POST',
                            body: formData
                        });
                        const data = await res.json();
                        if (data.status === 'ok') subidos++;
                    }

                    if (subidos > 0) {
                        Swal.close();
                        this.enviado = true; 
                    }
                } catch(e) {
                    Swal.fire('Error', 'Fallo en la carga.', 'error');
                }
            }
        }
    }).mount('#app');
</script>
</body>
</html>