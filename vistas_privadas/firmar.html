<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firma de Contratos | WSAC</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="/css/subsanar.css"> <style>
        .card-header-tech { background-color: #1e3a8a; color: white; padding: 20px; border-radius: 12px 12px 0 0; text-align: center; }
        .btn-upload-tech { background-color: #0891b2; color: white; font-weight: bold; border-radius: 8px; padding: 12px; border: none; transition: 0.3s; }
        .btn-upload-tech:hover { background-color: #0e7490; }
        .drop-zone-premium { border: 2px dashed #0891b2; padding: 30px; border-radius: 12px; text-align: center; cursor: pointer; background: #f0f9ff; transition: 0.3s; }
        .drop-zone-premium.active { background: #e0f2fe; border-color: #0e7490; }
    </style>
</head>
<body>

<div id="app" class="app-container py-5">
    <div class="container d-flex justify-content-center">
        <div class="subsanar-card animate-in shadow-lg" style="max-width: 500px; width: 100%; background: white; border-radius: 15px;">

            <div v-if="loading" class="p-5 text-center">
                <div class="spinner-border text-info" role="status"></div>
                <p class="mt-3 fw-bold text-muted">Validando enlace de firma...</p>
            </div>

            <div v-else-if="enviado" class="p-5 text-center animate-in">
                <i class="bi bi-check-circle-fill display-3 text-success"></i>
                <h4 class="fw-bold mt-3">¡Contratos Enviados!</h4>
                <p class="text-muted">Tu documentación firmada ha sido recibida con éxito por el área de contratación.</p>
                <button class="btn btn-outline-secondary btn-sm" onclick="window.close()">Cerrar Ventana</button>
            </div>

            <div v-else-if="error" class="p-5 text-center animate-in">
                <i class="bi bi-exclamation-triangle-fill display-3 text-danger"></i>
                <h4 class="fw-bold mt-3">Enlace Expirado</h4>
                <p class="text-muted small">{{ error }}</p>
            </div>

            <div v-else>
                <header class="card-header-tech">
                    <div class="security-icon-top mb-2"><i class="bi bi-pen-fill fs-2"></i></div>
                    <h3 class="h5 mb-0">Firma de Documentación</h3>
                </header>

                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        <span class="badge bg-success mb-2"><i class="bi bi-lock-fill"></i> Sesión Segura</span>
                        <p class="text-muted small">Hola, <strong>{{ usuario.nombres }}</strong>.<br>Por favor sube tus archivos debidamente firmados en formato PDF.</p>
                    </div>

                    <form @submit.prevent="procesarSubida">
                        
                        <div class="drop-zone-premium" :class="{'active': archivos.length > 0}" @click="triggerFileInput">
                            <input ref="archivoInput" type="file" class="d-none" @change="handleFileSelect" multiple accept="application/pdf">
                            <i class="bi bi-file-earmark-arrow-up text-info" style="font-size: 2.5rem;"></i>
                            <p class="small fw-bold mb-0 mt-2">
                                {{ archivos.length === 0 ? 'Haz clic para seleccionar PDFs' : 'Añadir más archivos...' }}
                            </p>
                        </div>

                        <div v-if="archivos.length > 0" class="mt-3">
                            <label class="text-muted small fw-bold mb-2">Archivos listos para enviar:</label>
                            <div v-for="(f, index) in archivos" :key="index" class="d-flex justify-content-between align-items-center p-2 mb-2 bg-light rounded border">
                                <span class="text-truncate small" style="max-width: 80%;">
                                    <i class="bi bi-file-pdf-fill text-danger"></i> {{ f.name }}
                                </span>
                                <i class="bi bi-trash text-danger cursor-pointer" @click.stop="eliminarArchivo(index)"></i>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-upload-tech w-100 mt-4" :disabled="archivos.length === 0">
                            <i class="bi bi-send-fill me-2"></i> ENVIAR DOCUMENTOS FIRMADOS
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                token: '',
                loading: true,
                enviado: false,
                error: null,
                usuario: { nombres: '' },
                archivos: []            
            }
        },
        mounted() {
            const params = new URLSearchParams(window.location.search);
            this.token = params.get('token');
            if (!this.token) { 
                this.error = "No se encontró un token de acceso."; 
                this.loading = false; 
                return; 
            }
            this.validarToken();
        },
        methods: {
            triggerFileInput() { this.$refs.archivoInput.click(); },
            
            handleFileSelect(event) {
                const nuevos = Array.from(event.target.files);
                this.archivos = [...this.archivos, ...nuevos];
                event.target.value = ''; // Reset input
            },

            eliminarArchivo(index) {
                this.archivos.splice(index, 1);
            },

            async validarToken() {
                try {
                    const res = await fetch(`/api/validar-token-firma/${this.token}`);
                    const data = await res.json();
                    if (data.status === 'ok') { 
                        this.usuario = data.usuario; 
                        this.loading = false;
                    } else { 
                        this.error = data.message;
                        this.loading = false;
                    }
                } catch (e) { 
                    this.error = "Error de comunicación con el servidor."; 
                    this.loading = false;
                }
            },

            async procesarSubida() {
                if (this.archivos.length === 0) return;
                
                Swal.fire({
                    title: 'Subiendo Documentos',
                    html: 'Estamos procesando tus firmas, espera un momento...',
                    allowOutsideClick: false,
                    didOpen: () => { Swal.showLoading() }
                });

                const formData = new FormData();
                formData.append('token', this.token);
                this.archivos.forEach(file => {
                    formData.append('archivos', file); // 'archivos' debe coincidir con upload.any() o upload.array('archivos')
                });

                try {
                    const res = await fetch(`/api/subir-firmados`, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    
                    if (data.status === 'ok') {
                        Swal.close();
                        this.enviado = true;
                    } else {
                        throw new Error(data.message);
                    }
                } catch(e) {
                    Swal.fire('Error', e.message || 'Fallo al subir los archivos.', 'error');
                }
            }
        }
    }).mount('#app');
</script>
</body>
</html>